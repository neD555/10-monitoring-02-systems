### "13.Системы мониторинга"
### Обязательные задания.
### 1.Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя платформу для вычислений с выдачей текстовых отчетов, которые сохраняются на диск. Взаимодействие с платформой осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы выведите в мониторинг и почему?
### Ответ.
Инфраструктура.
CPU utilization и load average. Вычисления нагружают процессор, важно видеть перегрузку и очереди.

RAM usage и swap usage. Чтобы исключить OOM и деградацию из-за свопинга.

Disk usage и free space. Отчеты пишутся на диск, критично не упереться в заполнение.

Disk IO wait. Медленная запись отчетов напрямую влияет на время ответа.

Inodes usage. Массовая генерация файлов может закончить иноды раньше диска.

### 2.Менеджер продукта посмотрев на ваши метрики сказал, что ему непонятно что такое RAM/inodes/CPUla. Также он сказал, что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы можете ему предложить?
### Ответ.
Я бы показал менеджеру не технические метрики, а понятные показатели качества сервиса.

Что предложить вместо RAM и CPU.

Доступность сервиса.
Сколько процентов времени сервис работает и отвечает клиентам.

Скорость работы.
За сколько секунд клиент получает результат. Например 95 процентов запросов быстрее 2 секунд.

Качество результата.
Сколько отчётов успешно сформировано.
Сколько отчётов упало с ошибкой.

Ошибки.
Процент запросов с ошибками вместо результата.

Очередь.
Сколько времени клиент ждёт начала расчёта.

Как это назвать для него.
Мы выполняем обязательства на 99 процентов.
Большинство клиентов получают результат за X секунд.
Ошибок Y процентов.

Итог.
Менеджер видит не CPU и RAM, а
работает ли сервис
быстро ли он работает
получают ли клиенты свои отчёты
сколько клиентов получают ошибку.

### 3.Вашей DevOps команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики в свою очередь хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации, чтобы разработчики получали ошибки приложения?
### Ответ.
Решение без отдельной системы логов.

Отправлять ошибки в мониторинг, а не в логи.
Экспортировать метрики ошибок из приложения.
Счётчик ошибок по типам и эндпоинтам.
Счётчик 5xx.
Доля ошибок от всех запросов.
Дальше настроить алерты в Prometheus Alertmanager и слать уведомления в Slack Telegram email.

Дать разработчикам быстрый просмотр ошибок через хост.
Собирать только stderr и error логи через systemd journalctl.
Доступ разработчикам на чтение логов.
Фильтры по сервису и по уровню error.
Это уже работает из коробки и бесплатно.

Сделать простой дешёвый сбор ошибок в файл и ротацию.
Писать error лог в отдельный файл.
logrotate на ежедневную ротацию и хранение например 7-14 дней.
Если серверов несколько то забирать эти файлы по ssh или rsync на один хост.

Если можно использовать бесплатный SaaS.
Sentry бесплатный тариф или open source вариант.
Это именно для ошибок, со стектрейсами и группировкой.
Даёт разработчикам то что они хотят без полноценного лог стека.

Минимум усилий и максимум пользы обычно даёт связка
метрики ошибок плюс алерты
и journalctl для деталей конкретного инцидента.

### 4.Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA=99% по http кодам ответов. Вычисляете этот параметр по следующей формуле: summ_2xx_requests/summ_all_requests. Данный параметр не поднимается выше 70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?
### Ответ.
Ошибка в знаменателе.

В summ_all_requests у тебя попадают не только завершённые HTTP ответы, но и то, что не является 2xx, 4xx, 5xx, например:

Таймауты на клиенте и на балансере
обрывы соединения до ответа
отменённые запросы
непопавшие в приложение запросы
какие то служебные метки в метрике, например code="0" или status="unknown" или empty.

В приложении ты смотришь только коды ответов, поэтому 4xx и 5xx не видишь, а в all у тебя учитываются ещё и такие незавершённые запросы, поэтому 2xx делится на большее число и выходит 70%.

Как починить:

Считать SLA по завершённым ответам: 2xx делить на 2xx+4xx+5xx
либо явно исключить code пустой unknown 0 и подобное из summ_all_requests
и отдельно вывести метрику aborted timeouts disconnects, чтобы видеть реальную причину потерь.

### 5.Опишите основные плюсы и минусы pull и push систем мониторинга.
### Ответ.
Pull система мониторинга:

Плюсы.
Центральная система сама забирает метрики.
Легко контролировать частоту опроса и формат данных.
Проще отлаживать, всегда понятно, кто и что опрашивает.
Безопаснее по умолчанию, не нужно открывать доступ на приём метрик со всех узлов.

Минусы.
Сложно работать с динамическими инстансами без дополнительного сервиса обнаружения.
Если узел недоступен, данные просто не придут, и нужно отдельно детектить эту ситуацию.
Нельзя пушить метрики из краткоживущих задач без специальных решений.

Push система мониторинга:

Плюсы.
Подходит для короткоживущих задач и batch job.
Проще масштабировать агентов, каждый сам отправляет данные.
Можно слать метрики из закрытых сетей и за NAT.

Минусы.
Сложнее контролировать, кто и как часто шлёт данные.
Риск перегрузить систему мониторинга потоком метрик.
Сложнее отлаживать и искать источник мусорных данных.
Требует защиты точки приёма метрик от несанкционированной отправки.

Коротко.
Pull лучше для серверов и сервисов.
Push лучше для джобов и временных процессов.

### 6.Какие из ниже перечисленных систем относятся к push модели, а какие к pull? А может есть гибридные?

Prometheus
TICK
Zabbix
VictoriaMetrics
Nagios
### Ответ.
Pull: Prometheus, Nagios.

Push: TICK.

Гибрид: Zabbix, VictoriaMetrics.

### 7.Склонируйте себе репозиторий и запустите TICK-стэк, используя технологии docker и docker-compose.

В виде решения на это упражнение приведите скриншот веб-интерфейса ПО chronograf (http://localhost:8888).

P.S.: если при запуске некоторые контейнеры будут падать с ошибкой - проставьте им режим Z, например ./data:/var/lib:Z

### Ответ.


